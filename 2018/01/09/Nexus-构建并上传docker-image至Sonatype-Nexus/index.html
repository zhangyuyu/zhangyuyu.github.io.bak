<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Nexus," />





  <link rel="alternate" href="/atom.xml" title="若见喻笺" type="application/atom+xml" />






<meta name="description" content="一、前言　　前面两篇文章Nexus - Sonatype Nexus搭建maven私服、Nexus - Gradle打包上传至Sonatype Nexus都是介绍maven相关的仓库，下载应用程序相关的依赖包，上传应用程序的构建产物。本篇文章将介绍docker相关的仓库，下载docker镜像，上传自己构建的应用程序的docker镜像。方便持续集成时候，能够直接从ci上获取应用程序镜像，进行部署。">
<meta name="keywords" content="Nexus">
<meta property="og:type" content="article">
<meta property="og:title" content="Nexus - 构建并上传docker image至Sonatype Nexus">
<meta property="og:url" content="http://yoursite.com/2018/01/09/Nexus-构建并上传docker-image至Sonatype-Nexus/index.html">
<meta property="og:site_name" content="若见喻笺">
<meta property="og:description" content="一、前言　　前面两篇文章Nexus - Sonatype Nexus搭建maven私服、Nexus - Gradle打包上传至Sonatype Nexus都是介绍maven相关的仓库，下载应用程序相关的依赖包，上传应用程序的构建产物。本篇文章将介绍docker相关的仓库，下载docker镜像，上传自己构建的应用程序的docker镜像。方便持续集成时候，能够直接从ci上获取应用程序镜像，进行部署。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://yoursite.com/imgs/nexus-docker-proxy-repository-connectors.png">
<meta property="og:image" content="http://yoursite.com/imgs/nexus-docker-proxy-registry-api.png">
<meta property="og:image" content="http://yoursite.com/imgs/nexus-docker-proxy-proxy.png">
<meta property="og:image" content="http://yoursite.com/imgs/nexus-docker-proxy-storage.png">
<meta property="og:image" content="http://yoursite.com/imgs/nexus-browse-docker-proxy.png">
<meta property="og:image" content="http://yoursite.com/imgs/nexus-docker-proxy-configure-port.png">
<meta property="og:image" content="http://yoursite.com/imgs/nexus-docker-proxy-daemon.png">
<meta property="og:image" content="http://yoursite.com/imgs/nexus-docker-hosted.png">
<meta property="og:image" content="http://yoursite.com/imgs/nexus-docker-group.png">
<meta property="og:image" content="http://yoursite.com/imgs/nexus-browse-docker-local.png">
<meta property="og:image" content="http://yoursite.com/imgs/nexus-browse-docker-group.png">
<meta property="og:updated_time" content="2018-05-27T09:18:56.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Nexus - 构建并上传docker image至Sonatype Nexus">
<meta name="twitter:description" content="一、前言　　前面两篇文章Nexus - Sonatype Nexus搭建maven私服、Nexus - Gradle打包上传至Sonatype Nexus都是介绍maven相关的仓库，下载应用程序相关的依赖包，上传应用程序的构建产物。本篇文章将介绍docker相关的仓库，下载docker镜像，上传自己构建的应用程序的docker镜像。方便持续集成时候，能够直接从ci上获取应用程序镜像，进行部署。">
<meta name="twitter:image" content="http://yoursite.com/imgs/nexus-docker-proxy-repository-connectors.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/01/09/Nexus-构建并上传docker-image至Sonatype-Nexus/"/>





  <title>Nexus - 构建并上传docker image至Sonatype Nexus | 若见喻笺</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">若见喻笺</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/09/Nexus-构建并上传docker-image至Sonatype-Nexus/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhang Yu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="若见喻笺">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Nexus - 构建并上传docker image至Sonatype Nexus</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-09T14:11:20+01:00">
                2018-01-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Devops/" itemprop="url" rel="index">
                    <span itemprop="name">Devops</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h2><p>　　前面两篇文章<a href="http://zhangyuyu.github.io/2018/01/07/Nexus-SonatypeNexus%E6%90%AD%E5%BB%BAmaven%E7%A7%81%E6%9C%8D/" target="_blank" rel="noopener">Nexus - Sonatype Nexus搭建maven私服</a>、<a href="http://zhangyuyu.github.io/2018/01/08/Nexus-Gradle%E6%89%93%E5%8C%85%E4%B8%8A%E4%BC%A0%E8%87%B3SonatypeNexus/" target="_blank" rel="noopener">Nexus - Gradle打包上传至Sonatype Nexus</a>都是介绍maven相关的仓库，下载应用程序相关的依赖包，上传应用程序的构建产物。<br>本篇文章将介绍docker相关的仓库，下载docker镜像，上传自己构建的应用程序的docker镜像。<br>方便持续集成时候，能够直接从ci上获取应用程序镜像，进行部署。</p>
<a id="more"></a>
<h2 id="二、搭建Nexus-docker仓库"><a href="#二、搭建Nexus-docker仓库" class="headerlink" title="二、搭建Nexus docker仓库"></a>二、搭建Nexus docker仓库</h2><p>　　下面我们会：</p>
<ul>
<li>创建一个docker proxy仓库，用于代理Docker Hub</li>
<li>创建一个docker hosted仓库，用于管理我们自己构建的镜像</li>
<li>创建一个docker group仓库，用于对上面两个仓库暴露统一的URL。</li>
</ul>
<p>　　与此同时，我们会创建三个blob：docker-hub-blob、docker-local-blob、docker-blob分别对应上面的docker proxy、docker hosted、docker group仓库。（创建blob的步骤略）</p>
<h3 id="1-创建docker-proxy仓库"><a href="#1-创建docker-proxy仓库" class="headerlink" title="1. 创建docker proxy仓库"></a>1. 创建docker proxy仓库</h3><h4 id="1-1-各项配置"><a href="#1-1-各项配置" class="headerlink" title="1.1 各项配置"></a>1.1 各项配置</h4><ul>
<li><p>Repository Connectors<br>　　<img src="/imgs/nexus-docker-proxy-repository-connectors.png" width="600" height="250"></p>
</li>
<li><p>Docker Registry API Support<br>　　<img src="/imgs/nexus-docker-proxy-registry-api.png" width="600" height="250"></p>
</li>
</ul>
<blockquote>
<p>　　Generally V1 support is only needed for repository groups that will be used for command line-based searches, when any client side tools in use require V1 or when a upstream proxy repository requires V1. If you are unsure if your setup uses these or V1, it is recommended to activate V1 support as there should be no harm if it is not needed.</p>
</blockquote>
<p>　　此处Enable v1之后，会允许使用V1作为V2的fallback。将来，V2会替代V1，但是有些功能（比如docker search）在V2中暂时还没实现。如果你不确定是否要enable V1，那么推荐你激活这个选项，因为激活这个选项不会造成任何危害，但是某些情况下，不激活反而会造成一些错误。</p>
<ul>
<li><p>Proxy<br>　　<img src="/imgs/nexus-docker-proxy-proxy.png" width="600" height="250"></p>
</li>
<li><p>Storage<br>　　<img src="/imgs/nexus-docker-proxy-storage.png" width="600" height="250"></p>
</li>
</ul>
<h4 id="1-2-从远程docker-hub获取base-image-tomcat-8-0-jre8-alpine"><a href="#1-2-从远程docker-hub获取base-image-tomcat-8-0-jre8-alpine" class="headerlink" title="1.2 从远程docker hub获取base image tomcat:8.0-jre8-alpine"></a>1.2 从远程docker hub获取base image <code>tomcat:8.0-jre8-alpine</code></h4><h5 id="1-2-1-宿主机和nexus-docker-proxy仓库的认证"><a href="#1-2-1-宿主机和nexus-docker-proxy仓库的认证" class="headerlink" title="1.2.1 宿主机和nexus docker proxy仓库的认证"></a>1.2.1 宿主机和nexus docker proxy仓库的认证</h5><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker login -u admin -p admin123 localhost:<span class="number">50002</span></span><br><span class="line"><span class="literal">WARNING</span>! Using <span class="comment">--password via the CLI is insecure. Use --password-stdin.</span></span><br><span class="line">Login Succeeded</span><br></pre></td></tr></table></figure>
<p>检查配置文件<code>~/.docker/config.json</code>：<br><figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ cat ~/.docker/config.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"auths"</span>: &#123;</span><br><span class="line">        <span class="string">"localhost:50000"</span>: &#123;&#125;,</span><br><span class="line">        <span class="string">"localhost:50001"</span>: &#123;&#125;,</span><br><span class="line">        <span class="string">"localhost:50002"</span>: &#123;&#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"HttpHeaders"</span>: &#123;</span><br><span class="line">        <span class="string">"User-Agent"</span>: <span class="string">"Docker-Client/17.09.1-ce (darwin)"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"credsStore"</span>: <span class="string">"osxkeychain"</span></span><br><span class="line">&#125;%</span><br></pre></td></tr></table></figure></p>
<h5 id="1-2-2-获取base-image"><a href="#1-2-2-获取base-image" class="headerlink" title="1.2.2 获取base image"></a>1.2.2 获取base image</h5><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ docker images</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">sonatype/nexus3     latest              <span class="number">0</span>b6b1bc88ccb        <span class="number">7</span> days ago          <span class="number">484</span>MB</span><br><span class="line"></span><br><span class="line">$ docker pull localhos<span class="variable">t:50000</span>/tomca<span class="variable">t:8</span>.<span class="number">0</span>-jre8-alpine</span><br><span class="line"><span class="number">8.0</span>-jre8-alpine: Pulling from tomcat</span><br><span class="line"><span class="number">2</span>fdfe1cd78c2: Pull <span class="built_in">complete</span></span><br><span class="line"><span class="number">82630</span>fd6e5b<span class="variable">a:</span> Pull <span class="built_in">complete</span></span><br><span class="line"><span class="number">119</span>d364c885d: Pull <span class="built_in">complete</span></span><br><span class="line"><span class="number">749</span>ddbaec87<span class="variable">a:</span> Pull <span class="built_in">complete</span></span><br><span class="line"><span class="number">801</span>c4e05625<span class="variable">b:</span> Pull <span class="built_in">complete</span></span><br><span class="line"><span class="number">08</span>b85d1fac84: Pull <span class="built_in">complete</span></span><br><span class="line"><span class="number">668</span>b34e85733: Pull <span class="built_in">complete</span></span><br><span class="line"><span class="number">859329</span>ae45ee: Pull <span class="built_in">complete</span></span><br><span class="line">Diges<span class="variable">t:</span> <span class="built_in">sha256</span>:fc67c79796f2bf034f9af3cf20fd1e051b780c403c31b945850c7e061c899bd7</span><br><span class="line">Statu<span class="variable">s:</span> Downloaded newer image <span class="keyword">for</span> localhos<span class="variable">t:50000</span>/tomca<span class="variable">t:8</span>.<span class="number">0</span>-jre8-alpine</span><br><span class="line"></span><br><span class="line">$ docker images</span><br><span class="line">REPOSITORY               TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">sonatype/nexus3          latest              <span class="number">0</span>b6b1bc88ccb        <span class="number">7</span> days ago          <span class="number">484</span>MB</span><br><span class="line">localhos<span class="variable">t:50000</span>/tomcat   <span class="number">8.0</span>-jre8-alpine     <span class="number">5</span>b01f7b2f446        <span class="number">3</span> weeks ago         <span class="number">117</span>MB</span><br></pre></td></tr></table></figure>
<h5 id="1-2-3-查看nexus-docker-proxy-仓库"><a href="#1-2-3-查看nexus-docker-proxy-仓库" class="headerlink" title="1.2.3 查看nexus docker proxy 仓库"></a>1.2.3 查看nexus docker proxy 仓库</h5><p>　　<img src="/imgs/nexus-browse-docker-proxy.png" width="600" height="500"><br>　　可以看到<code>tomcat:8.0-jre8-alpine</code>在我们的docker proxy仓库里也存下来了。</p>
<h4 id="1-3-可能出现的错误"><a href="#1-3-可能出现的错误" class="headerlink" title="1.3 可能出现的错误"></a>1.3 可能出现的错误</h4><h5 id="1-3-1-getsockopt-connection-refused"><a href="#1-3-1-getsockopt-connection-refused" class="headerlink" title="1.3.1 getsockopt: connection refused"></a>1.3.1 getsockopt: connection refused</h5><ul>
<li><p>具体错误：</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker login -u admin -p admin123 localhost:50002</span><br><span class="line"><span class="keyword">Error </span>response from daemon: Get http://localhost:50002/v2/: dial tcp [::1]:50000: getsockopt: connection refused</span><br></pre></td></tr></table></figure>
</li>
<li><p>原因：<br>　　nexus3-container端口号没有暴露给宿主机</p>
</li>
<li><p>解决办法<br>　　在Docker for mac的Configure Ports处暴露端口号50002（下图暴露了50000、500001、500002供下文所用）</p>
<img src="/imgs/nexus-docker-proxy-configure-port.png" width="500" height="250">
</li>
</ul>
<h5 id="1-3-2-401-Unauthorized"><a href="#1-3-2-401-Unauthorized" class="headerlink" title="1.3.2. 401 Unauthorized"></a>1.3.2. 401 Unauthorized</h5><ul>
<li><p>具体错误：</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker login -u admin -p admin123 localhost:50002</span><br><span class="line">WARNING! Using --password via the CLI is insecure. Use --password-stdin.</span><br><span class="line"><span class="keyword">Error </span>response from daemon: login attempt to http://localhost:50002/v2/ failed with status: 401 Unauthorized</span><br></pre></td></tr></table></figure>
</li>
<li><p>解决办法：<br>　　上面的Repository Connectors配置里，一定要勾选Force basic authentication</p>
</li>
</ul>
<h5 id="1-3-3-http-server-gave-HTTP-response-to-HTTPS-client"><a href="#1-3-3-http-server-gave-HTTP-response-to-HTTPS-client" class="headerlink" title="1.3.3. http: server gave HTTP response to HTTPS client"></a>1.3.3. http: server gave HTTP response to HTTPS client</h5><ul>
<li><p>具体错误：</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker login -u admin -p admin123 localhost:50002</span><br><span class="line">WARNING! Using --password via the CLI is insecure. Use --password-stdin.</span><br><span class="line"><span class="keyword">Error </span>response from daemon: Get https://localhost:50002/v2/: http: server gave HTTP response to HTTPS client</span><br></pre></td></tr></table></figure>
</li>
<li><p>原因：<br>　　宿主机上的Docker daemon应该用HTTP通信，而不是HTTPS。</p>
</li>
<li><p>解决办法<br>　　对于不同的操作系统，配置的方法不一样。</p>
</li>
</ul>
<p>　　对于Linux系统，应该在<code>/etc/docker/daemon.json</code>设置如下：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"insecure-registries"</span>: [</span><br><span class="line">    <span class="string">"localhost:50002"</span>,</span><br><span class="line">    <span class="string">"localhost:50001"</span>,</span><br><span class="line">    <span class="string">"localhost:50000"</span>,</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"disable-legacy-registry"</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>　　对于Windows or Mac，应该设置如下：<br>　　<img src="/imgs/nexus-docker-proxy-daemon.png" width="500" height="250"></p>
<h3 id="2-创建docker-hosted仓库"><a href="#2-创建docker-hosted仓库" class="headerlink" title="2. 创建docker hosted仓库"></a>2. 创建docker hosted仓库</h3><p>　　配置如下图所示：<br>　　<img src="/imgs/nexus-docker-hosted.png" width="600" height="600"></p>
<h3 id="3-创建docker-group仓库"><a href="#3-创建docker-group仓库" class="headerlink" title="3. 创建docker group仓库"></a>3. 创建docker group仓库</h3><p>　　配置如下图所示：<br>　　<img src="/imgs/nexus-docker-group.png" width="600" height="600"></p>
<h2 id="三、构建应用image上传至nexus"><a href="#三、构建应用image上传至nexus" class="headerlink" title="三、构建应用image上传至nexus"></a>三、构建应用image上传至nexus</h2><h3 id="1-构建应用image"><a href="#1-构建应用image" class="headerlink" title="1. 构建应用image"></a>1. 构建应用image</h3><h4 id="1-1-准备一个单独的文件夹，避免不必要的干扰"><a href="#1-1-准备一个单独的文件夹，避免不必要的干扰" class="headerlink" title="1.1 准备一个单独的文件夹，避免不必要的干扰"></a>1.1 准备一个单独的文件夹，避免不必要的干扰</h4><p>　　<code>mkdir docker</code></p>
<h4 id="1-2-准备材料Dockerfile和war包"><a href="#1-2-准备材料Dockerfile和war包" class="headerlink" title="1.2 准备材料Dockerfile和war包"></a>1.2 准备材料Dockerfile和war包</h4><ul>
<li>Dockerfile<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> localhost:<span class="number">50000</span>/tomcat:<span class="number">8.0</span>-jre8-alpine</span><br><span class="line"></span><br><span class="line"><span class="keyword">MAINTAINER</span> yuzhang &lt;<span class="number">1580074674</span>@qq.com&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> simple-web-1.0.0.war /usr/<span class="built_in">local</span>/tomcat/webapps/</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>　　端口号<code>50000</code>是docker group的端口号，该端口号既包含了docker proxy的端口，也包含了docker hosted的端口。</p>
<ul>
<li>simple-web-1.0.0.war<br>　　<code>cp build/libs/simple-web-1.0.0.war docker/</code></li>
</ul>
<h4 id="1-3-构建镜像"><a href="#1-3-构建镜像" class="headerlink" title="1.3 构建镜像"></a>1.3 构建镜像</h4><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -t localhost:<span class="number">50001</span>/<span class="built_in">simple</span>-web:<span class="number">1.0</span><span class="number">.0</span> .</span><br><span class="line">ending build context to Docker daemon  <span class="number">22.53</span>kB</span><br><span class="line"><span class="keyword">Step</span> <span class="number">1</span>/<span class="number">3</span> : FROM localhost:<span class="number">50000</span>/tomcat:<span class="number">8.0</span>-jre8-alpine</span><br><span class="line"> ---&gt; <span class="number">5</span>b01f7b2f446</span><br><span class="line"><span class="keyword">Step</span> <span class="number">2</span>/<span class="number">3</span> : MAINTAINER yuzhang &lt;<span class="number">1580074674</span>@qq.com&gt;</span><br><span class="line"> ---&gt; Running <span class="built_in">in</span> <span class="number">9</span>eba56fa9840</span><br><span class="line"> ---&gt; <span class="number">966</span>ac719976a</span><br><span class="line">Removing intermediate container <span class="number">9</span>eba56fa9840</span><br><span class="line"><span class="keyword">Step</span> <span class="number">3</span>/<span class="number">3</span> : ADD <span class="built_in">simple</span>-web<span class="number">-1.0</span><span class="number">.0</span>.war /usr/local/tomcat/webapps/</span><br><span class="line"> ---&gt; <span class="number">6</span>d3159ba5d64</span><br><span class="line">Successfully built <span class="number">6</span>d3159ba5d64</span><br><span class="line">Successfully tagged <span class="built_in">simple</span>-web:<span class="number">1.0</span><span class="number">.0</span></span><br></pre></td></tr></table></figure>
<p>　　这里的端口号只是为了待会上传时候，指定到docker hosted里面，因为group包含了两个端口。</p>
<h4 id="1-4-查看宿主机上镜像"><a href="#1-4-查看宿主机上镜像" class="headerlink" title="1.4 查看宿主机上镜像"></a>1.4 查看宿主机上镜像</h4><figure class="highlight leaf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">$ docker images</span><br><span class="line">REPOSITORY               TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">simple-web               1.0.0               6d3159ba5d64        20 seconds ago      117MB</span><br><span class="line">sonatype/nexus3          latest              0b6b1bc88ccb        7 days ago          484MB</span><br><span class="line">localhost:50000/tomcat   8.0-jre8-alpine     5b01f7b2f446        3 weeks ago         117MB</span><br><span class="line"></span><br><span class="line">$ docker history 6d3159ba5d64</span><br><span class="line">IMAGE               CREATED             CREATED BY                                      SIZE                COMMENT</span><br><span class="line">6d3159ba5d64        41 seconds ago      /bin/sh -c <span class="function"><span class="keyword">#</span><span class="params">(<span class="variable">nop</span>)</span></span> ADD file:1f503d2e5f794e3...   19.5kB</span><br><span class="line">966ac719976a        41 seconds ago      /bin/sh -c <span class="function"><span class="keyword">#</span><span class="params">(<span class="variable">nop</span>)</span></span>  MAINTAINER yuzhang &lt;158...   0B</span><br><span class="line">5b01f7b2f446        3 weeks ago         /bin/sh -c <span class="function"><span class="keyword">#</span><span class="params">(<span class="variable">nop</span>)</span></span>  CMD ["catalina.sh" "run"]    0B</span><br><span class="line">&lt;missing&gt;           3 weeks ago         /bin/sh -c <span class="function"><span class="keyword">#</span><span class="params">(<span class="variable">nop</span>)</span></span>  EXPOSE 8080/tcp              0B</span><br><span class="line">&lt;missing&gt;           3 weeks ago         /bin/sh -c set -e  &amp;&amp; nativeLines="$(catal...   0B</span><br><span class="line">&lt;missing&gt;           3 weeks ago         /bin/sh -c set -eux;   apk add --no-cache ...   20.9MB</span><br><span class="line">&lt;missing&gt;           3 weeks ago         /bin/sh -c <span class="function"><span class="keyword">#</span><span class="params">(<span class="variable">nop</span>)</span></span>  ENV TOMCAT_ASC_URLS=htt...   0B</span><br><span class="line">&lt;missing&gt;           3 weeks ago         /bin/sh -c <span class="function"><span class="keyword">#</span><span class="params">(<span class="variable">nop</span>)</span></span>  ENV TOMCAT_TGZ_URLS=htt...   0B</span><br><span class="line">&lt;missing&gt;           3 weeks ago         /bin/sh -c <span class="function"><span class="keyword">#</span><span class="params">(<span class="variable">nop</span>)</span></span>  ENV TOMCAT_SHA1=d2446c1...   0B</span><br><span class="line">&lt;missing&gt;           3 weeks ago         /bin/sh -c <span class="function"><span class="keyword">#</span><span class="params">(<span class="variable">nop</span>)</span></span>  ENV TOMCAT_VERSION=8.0.48    0B</span><br><span class="line">&lt;missing&gt;           5 weeks ago         /bin/sh -c <span class="function"><span class="keyword">#</span><span class="params">(<span class="variable">nop</span>)</span></span>  ENV TOMCAT_MAJOR=8           0B</span><br><span class="line">&lt;missing&gt;           5 weeks ago         /bin/sh -c set -ex;  for key in $GPG_KEYS;...   124kB</span><br><span class="line">&lt;missing&gt;           5 weeks ago         /bin/sh -c <span class="function"><span class="keyword">#</span><span class="params">(<span class="variable">nop</span>)</span></span>  ENV GPG_KEYS=05AB331109...   0B</span><br><span class="line">&lt;missing&gt;           5 weeks ago         /bin/sh -c apk add --no-cache gnupg             14.5MB</span><br><span class="line">&lt;missing&gt;           5 weeks ago         /bin/sh -c <span class="function"><span class="keyword">#</span><span class="params">(<span class="variable">nop</span>)</span></span>  ENV LD_LIBRARY_PATH=/us...   0B</span><br><span class="line">&lt;missing&gt;           5 weeks ago         /bin/sh -c <span class="function"><span class="keyword">#</span><span class="params">(<span class="variable">nop</span>)</span></span>  ENV TOMCAT_NATIVE_LIBDI...   0B</span><br><span class="line">&lt;missing&gt;           5 weeks ago         /bin/sh -c <span class="function"><span class="keyword">#</span><span class="params">(<span class="variable">nop</span>)</span></span> WORKDIR /usr/local/tomcat     0B</span><br><span class="line">&lt;missing&gt;           5 weeks ago         /bin/sh -c mkdir -p "$CATALINA_HOME"            0B</span><br><span class="line">&lt;missing&gt;           5 weeks ago         /bin/sh -c <span class="function"><span class="keyword">#</span><span class="params">(<span class="variable">nop</span>)</span></span>  ENV PATH=/usr/local/tom...   0B</span><br><span class="line">&lt;missing&gt;           5 weeks ago         /bin/sh -c <span class="function"><span class="keyword">#</span><span class="params">(<span class="variable">nop</span>)</span></span>  ENV CATALINA_HOME=/usr/...   0B</span><br><span class="line">&lt;missing&gt;           5 weeks ago         /bin/sh -c set -x  &amp;&amp; apk add --no-cache  ...   77.8MB</span><br><span class="line">&lt;missing&gt;           5 weeks ago         /bin/sh -c <span class="function"><span class="keyword">#</span><span class="params">(<span class="variable">nop</span>)</span></span>  ENV JAVA_ALPINE_VERSION...   0B</span><br><span class="line">&lt;missing&gt;           5 weeks ago         /bin/sh -c <span class="function"><span class="keyword">#</span><span class="params">(<span class="variable">nop</span>)</span></span>  ENV JAVA_VERSION=8u151       0B</span><br><span class="line">&lt;missing&gt;           5 weeks ago         /bin/sh -c <span class="function"><span class="keyword">#</span><span class="params">(<span class="variable">nop</span>)</span></span>  ENV PATH=/usr/local/sbi...   0B</span><br><span class="line">&lt;missing&gt;           5 weeks ago         /bin/sh -c <span class="function"><span class="keyword">#</span><span class="params">(<span class="variable">nop</span>)</span></span>  ENV JAVA_HOME=/usr/lib/...   0B</span><br><span class="line">&lt;missing&gt;           5 weeks ago         /bin/sh -c &#123;   echo '#!/bin/sh';   echo 's...   87B</span><br><span class="line">&lt;missing&gt;           5 weeks ago         /bin/sh -c <span class="function"><span class="keyword">#</span><span class="params">(<span class="variable">nop</span>)</span></span>  ENV LANG=C.UTF-8             0B</span><br><span class="line">&lt;missing&gt;           5 weeks ago         /bin/sh -c <span class="function"><span class="keyword">#</span><span class="params">(<span class="variable">nop</span>)</span></span>  CMD ["/bin/sh"]              0B</span><br><span class="line">&lt;missing&gt;           5 weeks ago         /bin/sh -c <span class="function"><span class="keyword">#</span><span class="params">(<span class="variable">nop</span>)</span></span> ADD file:2b00f26f6004576...   4.14MB</span><br></pre></td></tr></table></figure>
<h4 id="1-4-确保镜像可用"><a href="#1-4-确保镜像可用" class="headerlink" title="1.4 确保镜像可用"></a>1.4 确保镜像可用</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -it --rm -<span class="selector-tag">p</span> <span class="number">8090</span>:<span class="number">8080</span> --name dockerwar localhost:<span class="number">50001</span>/simple-web:<span class="number">1.0</span>.<span class="number">0</span></span><br><span class="line">Using CATALINA_BASE:   /usr/local/tomcat</span><br><span class="line">Using CATALINA_HOME:   /usr/local/tomcat</span><br><span class="line">Using CATALINA_TMPDIR: /usr/local/tomcat/temp</span><br><span class="line">Using JRE_HOME:        /usr/lib/jvm/java-<span class="number">1.8</span>-openjdk/jre</span><br><span class="line">Using CLASSPATH:       /usr/local/tomcat/bin/bootstrap<span class="selector-class">.jar</span>:/usr/local/tomcat/bin/tomcat-juli.jar</span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.050</span> INFO [main] org<span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.VersionLoggerListener</span><span class="selector-class">.log</span> Server version:        Apache Tomcat/<span class="number">8.0</span>.<span class="number">48</span></span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.052</span> INFO [main] org<span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.VersionLoggerListener</span><span class="selector-class">.log</span> Server built:          Nov <span class="number">30</span> <span class="number">2017</span> <span class="number">16</span>:<span class="number">26</span>:<span class="number">50</span> UTC</span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.052</span> INFO [main] org<span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.VersionLoggerListener</span><span class="selector-class">.log</span> Server number:         <span class="number">8.0</span>.<span class="number">48.0</span></span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.052</span> INFO [main] org<span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.VersionLoggerListener</span><span class="selector-class">.log</span> OS Name:               Linux</span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.052</span> INFO [main] org<span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.VersionLoggerListener</span><span class="selector-class">.log</span> OS Version:            <span class="number">4.9</span>.<span class="number">49</span>-moby</span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.053</span> INFO [main] org<span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.VersionLoggerListener</span><span class="selector-class">.log</span> Architecture:          amd64</span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.053</span> INFO [main] org<span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.VersionLoggerListener</span><span class="selector-class">.log</span> Java Home:             /usr/lib/jvm/java-<span class="number">1.8</span>-openjdk/jre</span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.053</span> INFO [main] org<span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.VersionLoggerListener</span><span class="selector-class">.log</span> JVM Version:           <span class="number">1.8</span>.<span class="number">0</span>_151-b12</span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.053</span> INFO [main] org<span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.VersionLoggerListener</span><span class="selector-class">.log</span> JVM Vendor:            Oracle Corporation</span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.053</span> INFO [main] org<span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.VersionLoggerListener</span><span class="selector-class">.log</span> CATALINA_BASE:         /usr/local/tomcat</span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.053</span> INFO [main] org<span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.VersionLoggerListener</span><span class="selector-class">.log</span> CATALINA_HOME:         /usr/local/tomcat</span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.054</span> INFO [main] org<span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.VersionLoggerListener</span><span class="selector-class">.log</span> Command line argument: -Djava<span class="selector-class">.util</span><span class="selector-class">.logging</span><span class="selector-class">.config</span><span class="selector-class">.file</span>=/usr/local/tomcat/conf/logging.properties</span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.054</span> INFO [main] org<span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.VersionLoggerListener</span><span class="selector-class">.log</span> Command line argument: -Djava<span class="selector-class">.util</span><span class="selector-class">.logging</span><span class="selector-class">.manager</span>=org<span class="selector-class">.apache</span><span class="selector-class">.juli</span><span class="selector-class">.ClassLoaderLogManager</span></span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.054</span> INFO [main] org<span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.VersionLoggerListener</span><span class="selector-class">.log</span> Command line argument: -Djdk<span class="selector-class">.tls</span><span class="selector-class">.ephemeralDHKeySize</span>=<span class="number">2048</span></span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.054</span> INFO [main] org<span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.VersionLoggerListener</span><span class="selector-class">.log</span> Command line argument: -Djava<span class="selector-class">.protocol</span><span class="selector-class">.handler</span><span class="selector-class">.pkgs</span>=org<span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.webresources</span></span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.055</span> INFO [main] org<span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.VersionLoggerListener</span><span class="selector-class">.log</span> Command line argument: -Dignore<span class="selector-class">.endorsed</span><span class="selector-class">.dirs</span>=</span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.055</span> INFO [main] org<span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.VersionLoggerListener</span><span class="selector-class">.log</span> Command line argument: -Dcatalina.base=/usr/local/tomcat</span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.055</span> INFO [main] org<span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.VersionLoggerListener</span><span class="selector-class">.log</span> Command line argument: -Dcatalina.home=/usr/local/tomcat</span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.055</span> INFO [main] org<span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.VersionLoggerListener</span><span class="selector-class">.log</span> Command line argument: -Djava<span class="selector-class">.io</span><span class="selector-class">.tmpdir</span>=/usr/local/tomcat/temp</span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.055</span> INFO [main] org<span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.core</span><span class="selector-class">.AprLifecycleListener</span><span class="selector-class">.lifecycleEvent</span> Loaded APR based Apache Tomcat Native library <span class="number">1.2</span>.<span class="number">16</span> using APR version <span class="number">1.6</span>.<span class="number">3</span>.</span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.055</span> INFO [main] org<span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.core</span><span class="selector-class">.AprLifecycleListener</span><span class="selector-class">.lifecycleEvent</span> APR capabilities: IPv6 [true], sendfile [true], accept filters [false], random [true].</span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.058</span> INFO [main] org<span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.core</span><span class="selector-class">.AprLifecycleListener</span><span class="selector-class">.initializeSSL</span> OpenSSL successfully initialized (OpenSSL <span class="number">1.0</span>.<span class="number">2</span>m  <span class="number">2</span> Nov <span class="number">2017</span>)</span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.140</span> INFO [main] org<span class="selector-class">.apache</span><span class="selector-class">.coyote</span><span class="selector-class">.AbstractProtocol</span><span class="selector-class">.init</span> Initializing ProtocolHandler [<span class="string">"http-apr-8080"</span>]</span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.147</span> INFO [main] org<span class="selector-class">.apache</span><span class="selector-class">.coyote</span><span class="selector-class">.AbstractProtocol</span><span class="selector-class">.init</span> Initializing ProtocolHandler [<span class="string">"ajp-apr-8009"</span>]</span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.148</span> INFO [main] org<span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.Catalina</span><span class="selector-class">.load</span> Initialization processed <span class="keyword">in</span> <span class="number">387</span> ms</span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.165</span> INFO [main] org<span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.core</span><span class="selector-class">.StandardService</span><span class="selector-class">.startInternal</span> Starting service Catalina</span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.165</span> INFO [main] org<span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.core</span><span class="selector-class">.StandardEngine</span><span class="selector-class">.startInternal</span> Starting Servlet Engine: Apache Tomcat/<span class="number">8.0</span>.<span class="number">48</span></span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.201</span> INFO [localhost-startStop-<span class="number">1</span>] org<span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.HostConfig</span><span class="selector-class">.deployWAR</span> Deploying web application archive /usr/local/tomcat/webapps/simple-web-<span class="number">1.0</span>.<span class="number">0</span>.war</span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.450</span> INFO [localhost-startStop-<span class="number">1</span>] org<span class="selector-class">.apache</span><span class="selector-class">.jasper</span><span class="selector-class">.servlet</span><span class="selector-class">.TldScanner</span><span class="selector-class">.scanJars</span> At least one JAR was scanned <span class="keyword">for</span> TLDs yet contained no TLDs. Enable debug logging <span class="keyword">for</span> this logger <span class="keyword">for</span> <span class="selector-tag">a</span> complete list of JARs that were scanned but no TLDs were found <span class="keyword">in</span> them. Skipping unneeded JARs during scanning can improve startup <span class="selector-tag">time</span> and JSP compilation <span class="selector-tag">time</span>.</span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.478</span> INFO [localhost-startStop-<span class="number">1</span>] org<span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.HostConfig</span><span class="selector-class">.deployWAR</span> Deployment of web application archive /usr/local/tomcat/webapps/simple-web-<span class="number">1.0</span>.<span class="number">0</span><span class="selector-class">.war</span> has finished <span class="keyword">in</span> <span class="number">277</span> ms</span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.480</span> INFO [localhost-startStop-<span class="number">1</span>] org<span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.HostConfig</span><span class="selector-class">.deployDirectory</span> Deploying web application directory /usr/local/tomcat/webapps/manager</span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.511</span> INFO [localhost-startStop-<span class="number">1</span>] org<span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.HostConfig</span><span class="selector-class">.deployDirectory</span> Deployment of web application directory /usr/local/tomcat/webapps/manager has finished <span class="keyword">in</span> <span class="number">31</span> ms</span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.511</span> INFO [localhost-startStop-<span class="number">1</span>] org<span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.HostConfig</span><span class="selector-class">.deployDirectory</span> Deploying web application directory /usr/local/tomcat/webapps/examples</span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.671</span> INFO [localhost-startStop-<span class="number">1</span>] org<span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.HostConfig</span><span class="selector-class">.deployDirectory</span> Deployment of web application directory /usr/local/tomcat/webapps/examples has finished <span class="keyword">in</span> <span class="number">160</span> ms</span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.672</span> INFO [localhost-startStop-<span class="number">1</span>] org<span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.HostConfig</span><span class="selector-class">.deployDirectory</span> Deploying web application directory /usr/local/tomcat/webapps/docs</span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.683</span> INFO [localhost-startStop-<span class="number">1</span>] org<span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.HostConfig</span><span class="selector-class">.deployDirectory</span> Deployment of web application directory /usr/local/tomcat/webapps/docs has finished <span class="keyword">in</span> <span class="number">11</span> ms</span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.683</span> INFO [localhost-startStop-<span class="number">1</span>] org<span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.HostConfig</span><span class="selector-class">.deployDirectory</span> Deploying web application directory /usr/local/tomcat/webapps/ROOT</span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.709</span> INFO [localhost-startStop-<span class="number">1</span>] org<span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.HostConfig</span><span class="selector-class">.deployDirectory</span> Deployment of web application directory /usr/local/tomcat/webapps/ROOT has finished <span class="keyword">in</span> <span class="number">26</span> ms</span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.709</span> INFO [localhost-startStop-<span class="number">1</span>] org<span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.HostConfig</span><span class="selector-class">.deployDirectory</span> Deploying web application directory /usr/local/tomcat/webapps/host-manager</span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.726</span> INFO [localhost-startStop-<span class="number">1</span>] org<span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.HostConfig</span><span class="selector-class">.deployDirectory</span> Deployment of web application directory /usr/local/tomcat/webapps/host-manager has finished <span class="keyword">in</span> <span class="number">17</span> ms</span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.729</span> INFO [main] org<span class="selector-class">.apache</span><span class="selector-class">.coyote</span><span class="selector-class">.AbstractProtocol</span><span class="selector-class">.start</span> Starting ProtocolHandler [<span class="string">"http-apr-8080"</span>]</span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.738</span> INFO [main] org<span class="selector-class">.apache</span><span class="selector-class">.coyote</span><span class="selector-class">.AbstractProtocol</span><span class="selector-class">.start</span> Starting ProtocolHandler [<span class="string">"ajp-apr-8009"</span>]</span><br><span class="line"><span class="number">10</span>-Jan-<span class="number">2018</span> <span class="number">06</span>:<span class="number">57</span>:<span class="number">07.741</span> INFO [main] org<span class="selector-class">.apache</span><span class="selector-class">.catalina</span><span class="selector-class">.startup</span><span class="selector-class">.Catalina</span><span class="selector-class">.start</span> Server startup <span class="keyword">in</span> <span class="number">592</span> ms</span><br></pre></td></tr></table></figure>
<p>　　浏览器访问<code>http://localhost:8090/simple-web-1.0.0/</code>，可以看到<code>hello world</code>出现。</p>
<ul>
<li><p>直接访问<code>http://localhost:8090/</code>，可以看到tomcat的页面，但是密码不确定。<br>可以直接登录到容器中查看<code>/usr/local/tomcat/conf/tomcat-users.xml</code>的配置</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ docker exec -it dockerwar /bin/bash</span><br><span class="line">bash-<span class="number">4.4</span><span class="comment"># ls</span></span><br><span class="line">LICENSE         RELEASE-NOTES   bin             <span class="keyword">include</span>         logs            temp            work</span><br><span class="line">NOTICE          RUNNING.txt     conf            <span class="class"><span class="keyword">lib</span>             <span class="title">native</span>-<span class="title">jni</span>-<span class="title">lib</span>  <span class="title">webapps</span></span></span><br><span class="line">$ docker exec -it dockerwar /bin/bash</span><br><span class="line">bash-<span class="number">4.4</span><span class="comment"># ls</span></span><br><span class="line">LICENSE         RELEASE-NOTES   bin             <span class="keyword">include</span>         logs            temp            work</span><br><span class="line">NOTICE          RUNNING.txt     conf            <span class="class"><span class="keyword">lib</span>             <span class="title">native</span>-<span class="title">jni</span>-<span class="title">lib</span>  <span class="title">webapps</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>上述应用的二级路由是<code>simple-web-1.0.0</code>，也可以从容器中看出来:</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bash<span class="number">-4.4</span># cd webapps/</span><br><span class="line">bash<span class="number">-4.4</span># ls</span><br><span class="line">ROOT                  docs                  examples              host-manager          manager               simple-web<span class="number">-1.0</span><span class="number">.0</span>      simple-web<span class="number">-1.0</span><span class="number">.0</span>.war</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="2-上传至nexus-local仓库"><a href="#2-上传至nexus-local仓库" class="headerlink" title="2. 上传至nexus local仓库"></a>2. 上传至nexus local仓库</h3><h4 id="2-1-上传"><a href="#2-1-上传" class="headerlink" title="2.1 上传"></a>2.1 上传</h4><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker push <span class="string">localhost:</span><span class="number">50001</span>/simple-<span class="string">web:</span><span class="number">1.0</span><span class="number">.0</span></span><br></pre></td></tr></table></figure>
<h4 id="2-2-查看docker-hosted仓库"><a href="#2-2-查看docker-hosted仓库" class="headerlink" title="2.2 查看docker hosted仓库"></a>2.2 查看<a href="http://localhost:32768/#browse/browse:docker-local" target="_blank" rel="noopener">docker hosted</a>仓库</h4><p>　　下图，可看到上传的simple-web应用的docker镜像了：<br>　　<img src="/imgs/nexus-browse-docker-local.png" width="600" height="500"></p>
<h4 id="2-3-查看docker-group仓库"><a href="#2-3-查看docker-group仓库" class="headerlink" title="2.3 查看docker group仓库"></a>2.3 查看<a href="http://localhost:32768/#browse/browse:docker-group" target="_blank" rel="noopener">docker group</a>仓库</h4><p>　　下图，可看到之前proxy中的上传的tomcat:8.0-jre8-alpine镜像，以及我们自己构建的simple-web应用的docker镜像了：<br>　　<img src="/imgs/nexus-browse-docker-group.png" width="600" height="500"></p>
<h4 id="2-4-删除本地镜像，从docker-hosted仓库获取镜像"><a href="#2-4-删除本地镜像，从docker-hosted仓库获取镜像" class="headerlink" title="2.4 删除本地镜像，从docker hosted仓库获取镜像"></a>2.4 删除本地镜像，从docker hosted仓库获取镜像</h4><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ docker pull localhos<span class="variable">t:50001</span>/simple-we<span class="variable">b:1</span>.<span class="number">0.0</span></span><br><span class="line"><span class="number">1.0</span>.<span class="number">0</span>: Pulling from simple-web</span><br><span class="line"><span class="number">2</span>fdfe1cd78c2: Already <span class="built_in">exists</span></span><br><span class="line"><span class="number">82630</span>fd6e5b<span class="variable">a:</span> Already <span class="built_in">exists</span></span><br><span class="line"><span class="number">119</span>d364c885d: Already <span class="built_in">exists</span></span><br><span class="line"><span class="number">749</span>ddbaec87<span class="variable">a:</span> Already <span class="built_in">exists</span></span><br><span class="line"><span class="number">801</span>c4e05625<span class="variable">b:</span> Already <span class="built_in">exists</span></span><br><span class="line"><span class="number">08</span>b85d1fac84: Already <span class="built_in">exists</span></span><br><span class="line"><span class="number">668</span>b34e85733: Already <span class="built_in">exists</span></span><br><span class="line"><span class="number">859329</span>ae45ee: Already <span class="built_in">exists</span></span><br><span class="line"><span class="number">46</span>f4c89e382c: Pull <span class="built_in">complete</span></span><br><span class="line">Diges<span class="variable">t:</span> <span class="built_in">sha256</span>:c99901dc39278d97cf33e9dbe0af9a95d3d6b081884a16c0f9c94649308f0b5c</span><br><span class="line">Statu<span class="variable">s:</span> Downloaded newer image <span class="keyword">for</span> localhos<span class="variable">t:50001</span>/simple-we<span class="variable">b:1</span>.<span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">$ docker images</span><br><span class="line">REPOSITORY                   TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">localhos<span class="variable">t:50001</span>/simple-web   <span class="number">1.0</span>.<span class="number">0</span>               <span class="number">326</span>e5af13176        <span class="number">6</span> hours ago         <span class="number">117</span>MB</span><br><span class="line">sonatype/nexus3              latest              <span class="number">0</span>b6b1bc88ccb        <span class="number">7</span> days ago          <span class="number">484</span>MB</span><br><span class="line">localhos<span class="variable">t:50000</span>/tomcat       <span class="number">8.0</span>-jre8-alpine     <span class="number">5</span>b01f7b2f446        <span class="number">3</span> weeks ago         <span class="number">117</span>MB</span><br></pre></td></tr></table></figure>
<h3 id="3-用shell脚本简化过程"><a href="#3-用shell脚本简化过程" class="headerlink" title="3. 用shell脚本简化过程"></a>3. 用shell脚本简化过程</h3><h4 id="3-1-编写shell脚本"><a href="#3-1-编写shell脚本" class="headerlink" title="3.1 编写shell脚本"></a>3.1 编写shell脚本</h4><p>　　将上述手动过程写在如下shell脚本中，其中包含了：生成war包、准备构建镜像材料、构建镜像、上传镜像、删除本地构建等内容：<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">DOCKER_HOSTED_REPO=localhost:50001</span><br><span class="line"></span><br><span class="line">./gradlew clean build</span><br><span class="line"></span><br><span class="line"><span class="keyword">mkdir</span> docker</span><br><span class="line"></span><br><span class="line">cp build/libs/simple-web-1.0.0.war docker/</span><br><span class="line"></span><br><span class="line">cp Dockerfile docker/</span><br><span class="line"></span><br><span class="line"><span class="keyword">cd</span> docker</span><br><span class="line"></span><br><span class="line">docker login -<span class="keyword">u</span> admin -p admin123 <span class="variable">$&#123;DOCKER_HOSTED_REPO&#125;</span></span><br><span class="line"></span><br><span class="line">docker build -t <span class="variable">$&#123;DOCKER_HOSTED_REPO&#125;</span>/simple-web:1.0.0 .</span><br><span class="line"></span><br><span class="line">docker push <span class="variable">$&#123;DOCKER_HOSTED_REPO&#125;</span>/simple-web:1.0.0</span><br><span class="line"></span><br><span class="line">docker rmi <span class="variable">$&#123;DOCKER_HOSTED_REPO&#125;</span>/simple-web:1.0.0</span><br><span class="line"></span><br><span class="line"><span class="keyword">rm</span> -rf docker/</span><br><span class="line"></span><br><span class="line"><span class="keyword">rm</span> -rf build/</span><br></pre></td></tr></table></figure></p>
<h4 id="3-2-更改执行权限"><a href="#3-2-更改执行权限" class="headerlink" title="3.2 更改执行权限"></a>3.2 更改执行权限</h4><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod <span class="number">777</span> <span class="keyword">go</span>.<span class="keyword">sh</span></span><br></pre></td></tr></table></figure>
<h4 id="3-3-执行脚本，进行测试"><a href="#3-3-执行脚本，进行测试" class="headerlink" title="3.3 执行脚本，进行测试"></a>3.3 执行脚本，进行测试</h4><p>　　执行脚本之前，可删除本地的程序构建产物、本地的应用程序docker镜像、远程的应用程序docker镜像。然后执行脚本之后，再次查看nexus hosted仓库是否有应用程序的docker镜像。<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ ./go.sh</span><br><span class="line"></span><br><span class="line">BUILD SUCCESSFUL <span class="keyword">in</span> <span class="number">0</span>s</span><br><span class="line"><span class="number">3</span> actionable <span class="string">tasks:</span> <span class="number">2</span> executed, <span class="number">1</span> up-to-date</span><br><span class="line">WARNING! Using --password via the CLI is insecure. Use --password-stdin.</span><br><span class="line">Login Succeeded</span><br><span class="line">Sending build context to Docker daemon  <span class="number">22.53</span>kB</span><br><span class="line">Step <span class="number">1</span><span class="regexp">/3 : FROM localhost:50000/</span><span class="string">tomcat:</span><span class="number">8.0</span>-jre8-alpine</span><br><span class="line"> ---&gt; <span class="number">5</span>b01f7b2f446</span><br><span class="line">Step <span class="number">2</span>/<span class="number">3</span> : MAINTAINER yuzhang &lt;<span class="number">1580074674</span><span class="meta">@qq</span>.com&gt;</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; fdcb287ed111</span><br><span class="line">Step <span class="number">3</span><span class="regexp">/3 : ADD simple-web-1.0.0.war /</span>usr<span class="regexp">/local/</span>tomcat<span class="regexp">/webapps/</span></span><br><span class="line"> ---&gt; <span class="number">29</span>f5f308b416</span><br><span class="line">Successfully built <span class="number">29</span>f5f308b416</span><br><span class="line">Successfully tagged <span class="string">localhost:</span><span class="number">50001</span>/simple-<span class="string">web:</span><span class="number">1.0</span><span class="number">.0</span></span><br><span class="line">The push refers to a repository [<span class="string">localhost:</span><span class="number">50001</span>/simple-web]</span><br><span class="line"><span class="number">8</span><span class="string">ccf53e87baa:</span> Pushed</span><br><span class="line"><span class="number">8</span><span class="string">d6f8df9c63b:</span> Pushed</span><br><span class="line"><span class="string">dab1340429ea:</span> Pushed</span><br><span class="line"><span class="string">dd97dc3a613e:</span> Pushed</span><br><span class="line"><span class="number">63680</span><span class="string">cd47754:</span> Pushed</span><br><span class="line"><span class="string">efe8908e7b83:</span> Pushed</span><br><span class="line"><span class="number">25</span><span class="string">baa3ba1903:</span> Pushed</span><br><span class="line"><span class="number">5</span><span class="string">b1e27e74327:</span> Pushed</span><br><span class="line"><span class="number">04</span><span class="string">a094fe844e:</span> Pushed</span><br><span class="line"><span class="number">1.0</span><span class="number">.0</span>: <span class="string">digest:</span> <span class="string">sha256:</span>a386f1897cade1c13919fb8236d3b9a5f5c9b6ba6122f526bd137a5e1395353e <span class="string">size:</span> <span class="number">2204</span></span><br></pre></td></tr></table></figure></p>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>　　本篇文章主要是利用nexus构建了docker相关的仓库（docker proxy、docker hosted、docker hosted仓库）。通过docker proxy仓库代理Docker Hub，从远程下载base image；基于base image构建自己的应用程序镜像；最后将应用程序镜像push到private的docker hosted仓库中。<br>　　根据构建产物构建镜像、上传镜像的过程，可以用一个shell脚本完成，详细可以参考Github代码。<br>　　Github代码地址：<a href="https://github.com/zhangyuyu/Simple-web" target="_blank" rel="noopener">https://github.com/zhangyuyu/Simple-web</a></p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li><a href="http://codeomitted.com/deploy-war-file-to-docker-image/" target="_blank" rel="noopener">Deploy war file to docker image</a></li>
<li><a href="http://www.sonatype.org/nexus/2017/02/16/using-nexus-3-as-your-repository-part-3-docker-images/" target="_blank" rel="noopener">Using Nexus 3 as Your Repository – Part 3: Docker Images</a></li>
<li><a href="https://help.sonatype.com/display/NXRM3/Proxy+Repository+for+Docker" target="_blank" rel="noopener">Proxy Repository for Docker</a></li>
<li><a href="http://jmkhael.io/building-and-publishing-a-docker-image/" target="_blank" rel="noopener">Building and publishing a Docker image</a></li>
</ul>

      
    </div>
    
    
    

    
      <div>
        <div id="wechat_subscriber" style="display: block; padding: 10px 0; margin: 20px auto; width: 100%; text-align: center">
    <img id="wechat_subscriber_qcode" src="/imgs/qr-code.png" alt="Zhang Yu wechat" style="width: 200px; max-width: 100%;"/>
    <div>扫一扫，用手机访问本站</div>
</div>

      </div>
    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Nexus/" rel="tag"># Nexus</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/01/08/Nexus-Gradle打包上传至SonatypeNexus/" rel="next" title="Nexus - Gradle打包上传至Sonatype Nexus">
                <i class="fa fa-chevron-left"></i> Nexus - Gradle打包上传至Sonatype Nexus
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/01/12/Nexus-构建jenkins容器、配置gradle-job从nexus获取依赖/" rel="prev" title="Nexus - 构建jenkins容器、配置gradle job从nexus获取依赖">
                Nexus - 构建jenkins容器、配置gradle job从nexus获取依赖 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Zhang Yu</p>
              <p class="site-description motion-element" itemprop="description">行是知之始，知是行之成</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">56</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">16</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">24</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#一、前言"><span class="nav-number">1.</span> <span class="nav-text">一、前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二、搭建Nexus-docker仓库"><span class="nav-number">2.</span> <span class="nav-text">二、搭建Nexus docker仓库</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-创建docker-proxy仓库"><span class="nav-number">2.1.</span> <span class="nav-text">1. 创建docker proxy仓库</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-各项配置"><span class="nav-number">2.1.1.</span> <span class="nav-text">1.1 各项配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-从远程docker-hub获取base-image-tomcat-8-0-jre8-alpine"><span class="nav-number">2.1.2.</span> <span class="nav-text">1.2 从远程docker hub获取base image tomcat:8.0-jre8-alpine</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-2-1-宿主机和nexus-docker-proxy仓库的认证"><span class="nav-number">2.1.2.1.</span> <span class="nav-text">1.2.1 宿主机和nexus docker proxy仓库的认证</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1-2-2-获取base-image"><span class="nav-number">2.1.2.2.</span> <span class="nav-text">1.2.2 获取base image</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1-2-3-查看nexus-docker-proxy-仓库"><span class="nav-number">2.1.2.3.</span> <span class="nav-text">1.2.3 查看nexus docker proxy 仓库</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-可能出现的错误"><span class="nav-number">2.1.3.</span> <span class="nav-text">1.3 可能出现的错误</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-3-1-getsockopt-connection-refused"><span class="nav-number">2.1.3.1.</span> <span class="nav-text">1.3.1 getsockopt: connection refused</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1-3-2-401-Unauthorized"><span class="nav-number">2.1.3.2.</span> <span class="nav-text">1.3.2. 401 Unauthorized</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1-3-3-http-server-gave-HTTP-response-to-HTTPS-client"><span class="nav-number">2.1.3.3.</span> <span class="nav-text">1.3.3. http: server gave HTTP response to HTTPS client</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-创建docker-hosted仓库"><span class="nav-number">2.2.</span> <span class="nav-text">2. 创建docker hosted仓库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-创建docker-group仓库"><span class="nav-number">2.3.</span> <span class="nav-text">3. 创建docker group仓库</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三、构建应用image上传至nexus"><span class="nav-number">3.</span> <span class="nav-text">三、构建应用image上传至nexus</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-构建应用image"><span class="nav-number">3.1.</span> <span class="nav-text">1. 构建应用image</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-准备一个单独的文件夹，避免不必要的干扰"><span class="nav-number">3.1.1.</span> <span class="nav-text">1.1 准备一个单独的文件夹，避免不必要的干扰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-准备材料Dockerfile和war包"><span class="nav-number">3.1.2.</span> <span class="nav-text">1.2 准备材料Dockerfile和war包</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-构建镜像"><span class="nav-number">3.1.3.</span> <span class="nav-text">1.3 构建镜像</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-4-查看宿主机上镜像"><span class="nav-number">3.1.4.</span> <span class="nav-text">1.4 查看宿主机上镜像</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-4-确保镜像可用"><span class="nav-number">3.1.5.</span> <span class="nav-text">1.4 确保镜像可用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-上传至nexus-local仓库"><span class="nav-number">3.2.</span> <span class="nav-text">2. 上传至nexus local仓库</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-上传"><span class="nav-number">3.2.1.</span> <span class="nav-text">2.1 上传</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-查看docker-hosted仓库"><span class="nav-number">3.2.2.</span> <span class="nav-text">2.2 查看docker hosted仓库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-查看docker-group仓库"><span class="nav-number">3.2.3.</span> <span class="nav-text">2.3 查看docker group仓库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-删除本地镜像，从docker-hosted仓库获取镜像"><span class="nav-number">3.2.4.</span> <span class="nav-text">2.4 删除本地镜像，从docker hosted仓库获取镜像</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-用shell脚本简化过程"><span class="nav-number">3.3.</span> <span class="nav-text">3. 用shell脚本简化过程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-编写shell脚本"><span class="nav-number">3.3.1.</span> <span class="nav-text">3.1 编写shell脚本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-更改执行权限"><span class="nav-number">3.3.2.</span> <span class="nav-text">3.2 更改执行权限</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-执行脚本，进行测试"><span class="nav-number">3.3.3.</span> <span class="nav-text">3.3 执行脚本，进行测试</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#最后"><span class="nav-number">4.</span> <span class="nav-text">最后</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#References"><span class="nav-number">5.</span> <span class="nav-text">References</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zhang Yu</span>
  
   <span style="margin-left:8px;">
   <script src="http://s6.cnzz.com/stat.php?id=1263347220&web_id=1263347220" type="text/javascript"></script>
   </span>


  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div>




        







  <div style="display: none;">
    <script src="//s95.cnzz.com/z_stat.php?id=1263347220&web_id=1263347220" language="JavaScript"></script>
  </div>



        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>


  

  <div style="display: none;">
    <script src="https://s19.cnzz.com/z_stat.php?id=1263347220&web_id=1263347220" language="JavaScript"></script>
  </div>




  


  




	





  





  












  





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  

  

  


</body>
</html>
